<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple GAPI Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        .warning { background: #fff3e0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Simple GAPI Test</h1>
    <button onclick="runTest()">Run GAPI Test</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log"></div>

    <script>
        const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
        const API_KEY = 'YOUR_GOOGLE_API_KEY';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        function log(message, type = 'log') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function runTest() {
            try {
                log('Starting GAPI initialization test...', 'log');

                // Step 1: Load Google API
                log('Step 1: Loading Google API script...', 'log');
                if (!window.gapi) {
                    await loadGoogleAPI();
                    log('✅ Google API script loaded', 'success');
                } else {
                    log('✅ Google API already loaded', 'success');
                }

                // Step 2: Load GAPI modules
                log('Step 2: Loading GAPI client:auth2...', 'log');
                await loadGAPIModules();
                log('✅ GAPI modules loaded', 'success');

                // Step 3: Initialize client
                log('Step 3: Initializing GAPI client...', 'log');
                await initializeClient();
                log('✅ GAPI client initialized', 'success');

                // Step 4: Check auth
                log('Step 4: Checking auth instance...', 'log');
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance) {
                    log('✅ Auth instance available', 'success');
                    log(`Auth status: ${authInstance.isSignedIn.get() ? 'Signed in' : 'Not signed in'}`, 'log');
                } else {
                    log('❌ Auth instance not available', 'error');
                }

                log('🎉 All tests passed!', 'success');

            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';

                script.onload = () => {
                    log('Google API script loaded from CDN', 'log');
                    resolve();
                };

                script.onerror = (error) => {
                    log('Failed to load Google API script', 'error');
                    reject(new Error('Failed to load Google API script'));
                };

                document.head.appendChild(script);
            });
        }

        function loadGAPIModules() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    log('GAPI module load timeout (20s)', 'error');
                    reject(new Error('GAPI module load timeout'));
                }, 20000);

                log('Calling gapi.load("client:auth2", ...)', 'log');

                gapi.load('client:auth2', {
                    callback: () => {
                        clearTimeout(timeout);
                        log('GAPI callback triggered successfully', 'log');
                        resolve();
                    },
                    onerror: (error) => {
                        clearTimeout(timeout);
                        log(`GAPI onerror triggered: ${JSON.stringify(error)}`, 'error');
                        reject(new Error(`GAPI load error: ${JSON.stringify(error)}`));
                    },
                    ontimeout: () => {
                        clearTimeout(timeout);
                        log('GAPI ontimeout triggered', 'error');
                        reject(new Error('GAPI load timeout'));
                    }
                });
            });
        }

        function initializeClient() {
            return new Promise(async (resolve, reject) => {
                try {
                    log(`Initializing with API Key: ${API_KEY.substring(0, 10)}...`, 'log');
                    log(`Initializing with Client ID: ${CLIENT_ID.substring(0, 30)}...`, 'log');
                    log(`Origin: ${window.location.origin}`, 'log');

                    await gapi.client.init({
                        apiKey: API_KEY,
                        clientId: CLIENT_ID,
                        discoveryDocs: [DISCOVERY_DOC],
                        scope: SCOPES
                    });

                    // Verify what's available after init
                    log(`gapi.client available: ${!!gapi.client}`, 'log');
                    log(`gapi.client.sheets available: ${!!gapi.client.sheets}`, 'log');
                    log(`gapi.auth2 available: ${!!gapi.auth2}`, 'log');

                    if (!gapi.client.sheets) {
                        throw new Error('Sheets API not available after init');
                    }

                    resolve();
                } catch (error) {
                    log(`Client init error: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        // Auto-run test on page load for quick debugging
        document.addEventListener('DOMContentLoaded', () => {
            log('Simple GAPI test page loaded', 'log');
            log(`Current URL: ${window.location.href}`, 'log');
            log(`User Agent: ${navigator.userAgent}`, 'log');
            log(`Online: ${navigator.onLine}`, 'log');
            log('Click "Run GAPI Test" to start', 'log');
        });
    </script>
</body>
</html>