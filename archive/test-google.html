<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Google Sheets API Test</h1>
    
    <div class="test-section info">
        <h3>Configuration Check</h3>
        <p><strong>Client ID:</strong> <span id="clientId">Loading...</span></p>
        <p><strong>API Key:</strong> <span id="apiKey">Loading...</span></p>
        <p><strong>Status:</strong> <span id="configStatus">Checking...</span></p>
    </div>

    <div class="test-section">
        <h3>API Tests</h3>
        <button onclick="testGoogleAPILoad()">1. Test Google API Load</button>
        <button onclick="testGAPIInit()">2. Test GAPI Init</button>
        <button onclick="testAuth()">3. Test Authentication</button>
        <button onclick="testSheetsAccess()">4. Test Sheets Access</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="log"></div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let gapi = null;
        let isGAPILoaded = false;
        let isGAPIInitialized = false;
        let isAuthenticated = false;

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        // Check configuration
        function checkConfig() {
            const clientIdSpan = document.getElementById('clientId');
            const apiKeySpan = document.getElementById('apiKey');
            const statusSpan = document.getElementById('configStatus');

            if (CONFIG && CONFIG.GOOGLE_SHEETS) {
                const clientId = CONFIG.GOOGLE_SHEETS.CLIENT_ID;
                const apiKey = CONFIG.GOOGLE_SHEETS.API_KEY;
                
                clientIdSpan.textContent = clientId ? `${clientId.substring(0, 20)}...` : 'Not set';
                apiKeySpan.textContent = apiKey ? `${apiKey.substring(0, 20)}...` : 'Not set';
                
                if (clientId && apiKey) {
                    statusSpan.textContent = 'Configured ✓';
                    statusSpan.style.color = 'green';
                    log('Configuration check passed');
                } else {
                    statusSpan.textContent = 'Missing credentials ✗';
                    statusSpan.style.color = 'red';
                    log('Configuration check failed - missing credentials', 'error');
                }
            } else {
                statusSpan.textContent = 'Config not loaded ✗';
                statusSpan.style.color = 'red';
                log('Configuration not loaded', 'error');
            }
        }

        // Test 1: Load Google API
        async function testGoogleAPILoad() {
            log('Testing Google API load...');
            try {
                if (window.gapi) {
                    log('Google API already loaded');
                    isGAPILoaded = true;
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        log('Google API script loaded successfully');
                        isGAPILoaded = true;
                        gapi = window.gapi;
                        resolve();
                    };
                    script.onerror = () => {
                        log('Failed to load Google API script', 'error');
                        reject(new Error('Failed to load Google API'));
                    };
                    document.head.appendChild(script);
                });
            } catch (error) {
                log(`Google API load failed: ${error.message}`, 'error');
            }
        }

        // Test 2: Initialize GAPI
        async function testGAPIInit() {
            if (!isGAPILoaded) {
                log('Google API not loaded. Run test 1 first.', 'error');
                return;
            }

            log('Testing GAPI initialization...');
            try {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('GAPI load timeout'));
                    }, 10000);

                    gapi.load('client:auth2', {
                        callback: () => {
                            clearTimeout(timeout);
                            log('GAPI client:auth2 loaded successfully');
                            resolve();
                        },
                        onerror: (error) => {
                            clearTimeout(timeout);
                            log(`GAPI load error: ${JSON.stringify(error)}`, 'error');
                            reject(error);
                        }
                    });
                });

                // Initialize client
                await gapi.client.init({
                    apiKey: CONFIG.GOOGLE_SHEETS.API_KEY,
                    clientId: CONFIG.GOOGLE_SHEETS.CLIENT_ID,
                    discoveryDocs: [CONFIG.GOOGLE_SHEETS.DISCOVERY_DOC],
                    scope: CONFIG.GOOGLE_SHEETS.SCOPES
                });

                log('GAPI client initialized successfully');
                isGAPIInitialized = true;
            } catch (error) {
                log(`GAPI initialization failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Test Authentication
        async function testAuth() {
            if (!isGAPIInitialized) {
                log('GAPI not initialized. Run test 2 first.', 'error');
                return;
            }

            log('Testing authentication...');
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    throw new Error('Auth instance not available');
                }

                log('Auth instance available');
                
                if (authInstance.isSignedIn.get()) {
                    log('User already signed in');
                    isAuthenticated = true;
                } else {
                    log('Attempting to sign in...');
                    const user = await authInstance.signIn();
                    
                    if (user.isSignedIn()) {
                        log('Sign in successful');
                        isAuthenticated = true;
                        
                        const profile = user.getBasicProfile();
                        log(`Signed in as: ${profile.getName()} (${profile.getEmail()})`);
                    } else {
                        throw new Error('Sign in failed');
                    }
                }
            } catch (error) {
                log(`Authentication failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Test Sheets Access
        async function testSheetsAccess() {
            if (!isAuthenticated) {
                log('Not authenticated. Run test 3 first.', 'error');
                return;
            }

            log('Testing Sheets API access...');
            try {
                // Try to create a test spreadsheet
                const response = await gapi.client.sheets.spreadsheets.create({
                    resource: {
                        properties: {
                            title: 'Workout Logger Test'
                        }
                    }
                });

                const spreadsheetId = response.result.spreadsheetId;
                log(`Test spreadsheet created successfully: ${spreadsheetId}`);
                
                // Try to write some data
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'Sheet1!A1:B2',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [
                            ['Date', 'Exercise'],
                            [new Date().toLocaleDateString(), 'Test Exercise']
                        ]
                    }
                });

                log('Test data written successfully');
                log('Sheets API test completed successfully ✓');
                
            } catch (error) {
                log(`Sheets API test failed: ${error.message}`, 'error');
                if (error.result && error.result.error) {
                    log(`Error details: ${JSON.stringify(error.result.error)}`, 'error');
                }
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkConfig();
            log('Test page loaded. Run tests in order: 1 → 2 → 3 → 4');
        });
    </script>
</body>
</html>
